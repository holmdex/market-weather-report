---
title: "Global Market Weather Report üåç"
subtitle: "Your Monthly Guide to Market Movement"
date: "`r format(Sys.time(), '%B %Y')`"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: true
    code_folding: none
    self_contained: true
    highlight: null
---

```{r setup, include=FALSE}
# Global chunk options
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8,
  results = 'asis'
)

# Install and load required packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyverse,
  quantmod,
  rvest,
  httr,
  jsonlite,
  plotly,
  DT,
  scales,
  lubridate,
  viridis,
  kableExtra,
  forecast,
  TTR,
  gridExtra
)

# Set time periods
current_date <- Sys.Date()
last_month_end <- floor_date(current_date, "month") - days(1)
last_month_start <- floor_date(last_month_end, "month")
year_start <- floor_date(current_date, "year")

# Define global markets to track with added Canada and Australia
market_indices <- list(
  US = c(
    "^GSPC" = "S&P 500 (US Large Companies)",
    "^DJI" = "Dow Jones (US Blue Chips)",
    "^IXIC" = "NASDAQ (US Tech Focus)"
  ),
  Asia = c(
    "^N225" = "Nikkei 225 (Japan)",
    "^HSI" = "Hang Seng (Hong Kong)",
    "000001.SS" = "Shanghai Composite (China)",
    "^NSEI" = "Nifty 50 (India)"
  ),
  Europe = c(
    "^FTSE" = "FTSE 100 (UK)",
    "^GDAXI" = "DAX (Germany)",
    "^FCHI" = "CAC 40 (France)",
    "^OMX" = "OMX 30 (Sweden)"
  ),
  Americas = c(
    "^GSPTSE" = "S&P/TSX Composite (Canada)"
  ),
  Pacific = c(
    "^AORD" = "All Ordinaries (Australia)"
  )
)

# Enhanced color palette with more distinct colors
options(
  plotly.palette = function() {
    c("#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", 
      "#FFEEAD", "#D4A5A5", "#9B6B6B", "#E6AF2E",
      "#A0522D", "#6B5B95", "#2E86C1", "#28B463",
      "#FF69B4")
  }
)

# Function to fetch market data from multiple sources
fetch_market_data <- function(symbol, from_date, to_date) {
  data <- NULL
  Sys.sleep(2)
  
  methods <- list(
    quantmod = function() {
      data <- getSymbols(symbol, src = "yahoo", 
                        from = from_date, 
                        to = to_date, 
                        auto.assign = FALSE)
      data.frame(
        date = index(data),
        price = as.numeric(Cl(data)),
        high = as.numeric(Hi(data)),
        low = as.numeric(Lo(data)),
        open = as.numeric(Op(data)),
        close = as.numeric(Cl(data)),
        volume = as.numeric(Vo(data)),
        symbol = symbol
      )
    },
    yahoo_api = function() {
      from_unix <- as.numeric(as.POSIXct(from_date))
      to_unix <- as.numeric(as.POSIXct(to_date))
      url <- sprintf(
        "https://query1.finance.yahoo.com/v8/finance/chart/%s?period1=%d&period2=%d&interval=1d",
        URLencode(symbol), from_unix, to_unix
      )
      response <- httr::GET(url)
      content <- fromJSON(rawToChar(response$content))
      result <- content$chart$result[[1]]
      data.frame(
        date = as.Date(as.POSIXct(result$timestamp, origin = "1970-01-01")),
        price = result$indicators$quote[[1]]$close,
        high = result$indicators$quote[[1]]$high,
        low = result$indicators$quote[[1]]$low,
        open = result$indicators$quote[[1]]$open,
        close = result$indicators$quote[[1]]$close,
        volume = result$indicators$quote[[1]]$volume,
        symbol = symbol
      )
    }
  )
  
  for(method_name in names(methods)) {
    tryCatch({
      data <- methods[[method_name]]()
      if(!is.null(data)) break
    }, error = function(e) {
      message(sprintf("%s failed for %s", method_name, symbol))
    })
  }
  
  if (!is.null(data)) {
    data %>%
      arrange(date) %>%
      filter(weekdays(date) != "Sunday") %>%
      mutate(
        returns = (price / lag(price) - 1) * 100,
        norm_price = price / first(price) * 100,
        trading_range = high - low,
        range_pct = trading_range / low * 100
      ) %>%
      na.omit()
  } else {
    NULL
  }
}

# Get monthly data
monthly_data <- lapply(names(market_indices), function(region) {
  lapply(names(market_indices[[region]]), function(symbol) {
    data <- fetch_market_data(symbol, last_month_start, last_month_end)
    if(!is.null(data)) {
      data$region <- region
      data$index_name <- market_indices[[region]][symbol]
    }
    data
  }) %>% bind_rows()
}) %>% bind_rows()

# Get yearly data
yearly_data <- lapply(names(market_indices), function(region) {
  lapply(names(market_indices[[region]]), function(symbol) {
    data <- fetch_market_data(symbol, year_start, current_date)
    if(!is.null(data)) {
      data$region <- region
      data$index_name <- market_indices[[region]][symbol]
    }
    data
  }) %>% bind_rows()
}) %>% bind_rows()
```
## Welcome to Your Market Weather Report! üå°Ô∏è

This report shows how markets around the world are doing - think of it like a weather report for the financial world. Just like weather can be sunny, cloudy, or rainy, markets can be doing well, staying steady, or facing challenges.

### Understanding Market Weather (Last Month)

```{r monthly_weather, echo=FALSE}
# Create monthly market weather indicators
monthly_weather_summary <- monthly_data %>%
  group_by(region, index_name) %>%
  summarize(
    last_return = last(returns),
    .groups = 'drop'  # This ensures we drop the grouping
  ) %>%
  mutate(
    weather_icon = case_when(
      last_return >= 5 ~ "üåû",        # Exceptional monthly gain
      last_return >= 3 ~ "üå§Ô∏è",        # Strong monthly gain
      last_return >= 1 ~ "‚õÖ",         # Moderate monthly gain
      last_return >= 0 ~ "üå•Ô∏è",        # Slight monthly gain
      last_return >= -1 ~ "‚òÅÔ∏è",       # Stable/minor decline
      last_return >= -3 ~ "üåßÔ∏è",       # Moderate decline
      last_return >= -5 ~ "‚õàÔ∏è",       # Significant decline
      last_return >= -7 ~ "üå™Ô∏è",       # Major decline
      TRUE ~ "‚ö°"                      # Severe decline
    ),
    conditions = case_when(
      last_return >= 5 ~ "Exceptional Month (Outstanding Performance)",
      last_return >= 3 ~ "Very Strong Month (Robust Growth)",
      last_return >= 1 ~ "Strong Month (Solid Growth)",
      last_return >= 0 ~ "Positive Month (Steady Progress)",
      last_return >= -1 ~ "Stable Month (Minor Fluctuation)",
      last_return >= -3 ~ "Challenging Month (Moderate Weakness)",
      last_return >= -5 ~ "Difficult Month (Notable Decline)",
      last_return >= -7 ~ "Tough Month (Significant Pressure)",
      TRUE ~ "Critical Month (Severe Market Stress)"
    ),
    mood_color = case_when(
      last_return >= 5 ~ "#006400",   # Dark green
      last_return >= 3 ~ "#4CAF50",   # Medium green
      last_return >= 1 ~ "#8BC34A",   # Light green
      last_return >= 0 ~ "#CDDC39",   # Lime
      last_return >= -1 ~ "#FFC107",  # Amber
      last_return >= -3 ~ "#FF9800",  # Orange
      last_return >= -5 ~ "#FF5722",  # Deep orange
      last_return >= -7 ~ "#F44336",  # Red
      TRUE ~ "#B71C1C"                # Dark red
    ),
    last_return = sprintf("%.2f", last_return)
  )

# Create the monthly weather summary table
monthly_table <- monthly_weather_summary %>%
  select(region, index_name, last_return, weather_icon, conditions)

# Apply row-specific styling
table_styled <- kable(monthly_table,
    format = "html",
    escape = FALSE,
    col.names = c("Region", "Market", "Last Month's Change %", "Weather", "Conditions"),
    align = c('l', 'l', 'r', 'c', 'l'),
    table.attr = 'class="table table-striped"'
  ) %>% 
  kable_styling() %>%
  row_spec(0, background = "#B0E0E6", color = "black")

# Apply individual row colors
for(i in 1:nrow(monthly_weather_summary)) {
  table_styled <- table_styled %>%
    row_spec(i, background = monthly_weather_summary$mood_color[i], color = "black")
}

table_styled

```


### Understanding Market Weather (This Year)

```{r yearly_weather, echo=FALSE}
# Create yearly market weather indicators
yearly_weather_summary <- yearly_data %>%
  group_by(region, index_name) %>%
  summarize(
    total_return = (last(price) / first(price) - 1) * 100,
    .groups = 'drop'  # This ensures we drop the grouping
  ) %>%
  mutate(
    weather_icon = case_when(
      total_return >= 20 ~ "üåû",      # Exceptional year
      total_return >= 15 ~ "üå§Ô∏è",      # Very strong year
      total_return >= 10 ~ "‚õÖ",       # Strong year
      total_return >= 5 ~ "üå•Ô∏è",       # Positive year
      total_return >= 0 ~ "‚òÅÔ∏è",       # Stable year
      total_return >= -5 ~ "üåßÔ∏è",      # Challenging year
      total_return >= -10 ~ "‚õàÔ∏è",     # Difficult year
      total_return >= -15 ~ "üå™Ô∏è",     # Tough year
      TRUE ~ "‚ö°"                      # Critical year
    ),
    conditions = case_when(
      total_return >= 20 ~ "Exceptional Year (Bull Market Leader)",
      total_return >= 15 ~ "Very Strong Year (Robust Bull Run)",
      total_return >= 10 ~ "Strong Year (Solid Performance)",
      total_return >= 5 ~ "Good Year (Steady Growth)",
      total_return >= 0 ~ "Stable Year (Maintaining Value)",
      total_return >= -5 ~ "Challenging Year (Minor Correction)",
      total_return >= -10 ~ "Difficult Year (Correction Territory)",
      total_return >= -15 ~ "Tough Year (Deep Correction)",
      TRUE ~ "Critical Year (Bear Market Territory)"
    ),
    mood_color = case_when(
      total_return >= 20 ~ "#006400",  # Dark green
      total_return >= 15 ~ "#4CAF50",  # Medium green
      total_return >= 10 ~ "#8BC34A",  # Light green
      total_return >= 5 ~ "#CDDC39",   # Lime
      total_return >= 0 ~ "#FFC107",   # Amber
      total_return >= -5 ~ "#FF9800",  # Orange
      total_return >= -10 ~ "#FF5722", # Deep orange
      total_return >= -15 ~ "#F44336", # Red
      TRUE ~ "#B71C1C"                 # Dark red
    ),
    total_return = sprintf("%.2f", total_return)
  )

# Create the yearly weather summary table
yearly_table <- yearly_weather_summary %>%
  select(region, index_name, total_return, weather_icon, conditions)

# Apply row-specific styling
table_styled <- kable(yearly_table,
    format = "html",
    escape = FALSE,
    col.names = c("Region", "Market", "Year-to-Date Change %", "Weather", "Conditions"),
    align = c('l', 'l', 'r', 'c', 'l'),
    table.attr = 'class="table table-striped"'
  ) %>% 
  kable_styling() %>%
  row_spec(0, background = "#B0E0E6", color = "black")

# Apply individual row colors
for(i in 1:nrow(yearly_weather_summary)) {
  table_styled <- table_styled %>%
    row_spec(i, background = yearly_weather_summary$mood_color[i], color = "black")
}

table_styled
```

#### Understanding the Weather Icons:
- üåû Bright and Sunny: Exceptional performance
- üå§Ô∏è Mostly Sunny: Very strong performance
- ‚õÖ Partly Sunny: Strong performance
- üå•Ô∏è Mostly Cloudy: Positive but moderate
- ‚òÅÔ∏è Cloudy: Stable/neutral performance
- üåßÔ∏è Light Rain: Minor weakness
- ‚õàÔ∏è Storm: Significant weakness
- üå™Ô∏è Tornado: Major turbulence
- ‚ö° Lightning: Severe market stress

## Market Performance Journey üìà

### This Month's Story
```{r monthly_performance}
# Monthly performance plot with enhanced configuration
monthly_plot <- plot_ly(monthly_data, x = ~date, y = ~norm_price, 
                       color = ~index_name,
                       colors = getOption("plotly.palette")()) %>%
  add_lines(
    text = ~paste(
      index_name,
      "\nDate: ", format(date, "%b %d"),
      "\nValue: ", round(norm_price, 1)
    ),
    hoverinfo = "text"
  ) %>%
  layout(
    title = list(
      text = paste0(
        "Monthly Market Performance (All Start at 100)",
        "<br>",
        "<sup>Double-Click on market names to see through the fog! üîç</sup>"
      ),
      font = list(size = 24, color = "black"),
      y = 0.95
    ),
    plot_bgcolor = "#F7FBFF",
    paper_bgcolor = "#F7FBFF",
    yaxis = list(
      title = "Value (Starting Point = 100)",
      tickfont = list(size = 12, color = "black"),
      gridcolor = "#E1E5EA",
      fixedrange = FALSE,
      automargin = TRUE
    ),
    xaxis = list(
      title = "Date",
      tickfont = list(size = 12, color = "black"),
      gridcolor = "#E1E5EA",
      automargin = TRUE
    ),
    margin = list(l = 80, r = 80, t = 100, b = 80),
    height = 600,
    showlegend = TRUE,
    legend = list(
      orientation = "h",
      y = -0.2,
      x = 0.5,
      xanchor = "center",
      bgcolor = "rgba(255, 255, 255, 0.9)",
      bordercolor = "#E1E5EA",
      borderwidth = 1,
      font = list(color = "black")
    )
  )

monthly_plot
```

### This Year's Journey
```{r yearly_performance}
# Yearly performance plot with enhanced configuration
yearly_plot <- plot_ly(yearly_data, x = ~date, y = ~norm_price, 
                      color = ~index_name,
                      colors = getOption("plotly.palette")()) %>%
  add_lines(
    text = ~paste(
      index_name,
      "\nDate: ", format(date, "%b %d"),
      "\nValue: ", round(norm_price, 1)
    ),
    hoverinfo = "text"
  ) %>%
  layout(
    title = list(
      text = paste0(
        "Yearly Market Performance (All Start at 100)",
        "<br>",
        "<sup>Double-Click on market names to see through the fog! üîç</sup>"
      ),
      font = list(size = 24, color = "black"),
      y = 0.95
    ),
    plot_bgcolor = "#F7FBFF",
    paper_bgcolor = "#F7FBFF",
    yaxis = list(
      title = "Value (Starting Point = 100)",
      tickfont = list(size = 12, color = "black"),
      gridcolor = "#E1E5EA",
      fixedrange = FALSE,
      automargin = TRUE
    ),
    xaxis = list(
      title = "Date",
      tickfont = list(size = 12, color = "black"),
      gridcolor = "#E1E5EA",
      automargin = TRUE
    ),
    margin = list(l = 80, r = 80, t = 100, b = 80),
    height = 600,
    showlegend = TRUE,
    legend = list(
      orientation = "h",
      y = -0.2,
      x = 0.5,
      xanchor = "center",
      bgcolor = "rgba(255, 255, 255, 0.9)",
      bordercolor = "#E1E5EA",
      borderwidth = 1,
      font = list(color = "black")
    )
  )

yearly_plot
```

## Looking Ahead: Market Forecast üîÆ

### What Might the Next Two Weeks Bring?
```{r forecast_analysis}
# Create forecasts for each market
forecasts <- monthly_data %>%
  group_by(index_name) %>%
  group_modify(~{
    # Create time series for prediction
    ts_data <- ts(.x$price, frequency = 7)
    
    # Use Holt-Winters to make a forecast
    hw_fit <- HoltWinters(ts_data)
    hw_forecast <- forecast(hw_fit, h = 14)
    
    # Create forecast dataframe with weekday filter
    forecast_dates <- seq(max(.x$date) + 1, by = "day", length.out = 14)
    forecast_dates <- forecast_dates[weekdays(forecast_dates) != "Sunday"]
    
    data.frame(
      date = forecast_dates,
      forecast = as.numeric(hw_forecast$mean)[1:length(forecast_dates)],
      lower_95 = as.numeric(hw_forecast$lower[,2])[1:length(forecast_dates)],
      upper_95 = as.numeric(hw_forecast$upper[,2])[1:length(forecast_dates)]
    )
  })

# Create enhanced forecast visualization
forecast_plot <- plot_ly() %>%
  add_lines(data = monthly_data, 
           x = ~date, 
           y = ~price,
           color = ~index_name,
           colors = getOption("plotly.palette")(),
           name = ~index_name,
           legendgroup = ~index_name,
           line = list(width = 2),
           text = ~paste(
             index_name,
             "\nDate:", format(date, "%b %d"),
             "\nValue:", round(price, 2)
           ),
           hoverinfo = "text") %>%
  add_ribbons(data = forecasts,
             x = ~date,
             ymin = ~lower_95,
             ymax = ~upper_95,
             color = ~index_name,
             colors = getOption("plotly.palette")(),
             opacity = 0.2,
             legendgroup = ~index_name,
             showlegend = FALSE,
             name = "Possible Range",
             text = ~paste(
               index_name,
               "\nDate:", format(date, "%b %d"),
               "\nRange:", round(lower_95, 2), "to", round(upper_95, 2)
             ),
             hoverinfo = "text") %>%
  add_lines(data = forecasts,
           x = ~date,
           y = ~forecast,
           color = ~index_name,
           colors = getOption("plotly.palette")(),
           line = list(dash = 'dash'),
           legendgroup = ~index_name,
           showlegend = FALSE,
           text = ~paste(
             index_name,
             "\nDate:", format(date, "%b %d"),
             "\nForecast:", round(forecast, 2)
           ),
           hoverinfo = "text") %>%
  layout(
    title = list(
      text = paste0(
        "Market Crystal Ball: Next Two Weeks",
        "<br>",
        "<sup>Double-Click on market names to see each market's potential future path! üîÆ</sup>"
      ),
      font = list(size = 24, color = "black"),
      y = 0.95
    ),
    plot_bgcolor = "#F7FBFF",
    paper_bgcolor = "#F7FBFF",
    yaxis = list(
      title = "Price Level",
      gridcolor = "#E1E5EA",
      tickfont = list(size = 12, color = "black"),
      automargin = TRUE
    ),
    xaxis = list(
      title = "Date",
      gridcolor = "#E1E5EA",
      tickfont = list(size = 12, color = "black"),
      automargin = TRUE
    ),
    margin = list(l = 80, r = 80, t = 100, b = 80),
    height = 600,
    legend = list(
      orientation = "h",
      y = -0.2,
      x = 0.5,
      xanchor = "center",
      bgcolor = "rgba(255, 255, 255, 0.9)",
      bordercolor = "#E1E5EA",
      borderwidth = 1,
      font = list(color = "black")
    ),
    shapes = list(
      list(
        type = "line",
        x0 = max(monthly_data$date),
        x1 = max(monthly_data$date),
        y0 = 0,
        y1 = 1,
        yref = "paper",
        line = list(color = "#957DAD", dash = "dot", width = 2)
      )
    ),
    annotations = list(
      list(
        x = max(monthly_data$date),
        y = 1,
        yref = "paper",
        text = "Forecast Starts",
        showarrow = FALSE,
        bgcolor = "white",
        bordercolor = "#957DAD",
        font = list(size = 14, color = "black")
      )
    )
  )

forecast_plot
```
### Understanding the Crystal Ball View üîÆ

The crystal ball shows three key elements for each market:
- Solid Line: The actual market journey so far
- Dashed Line: The most likely path ahead
- Shaded Area: The range of possible movements

When you double-click on a market name in the legend, you'll see:
1. Where that market has been (solid line)
2. Where it might go (dashed line)
3. The range of possibilities (shaded area)

This helps clear away the fog and focus on one market at a time!

## The Market's Weekly Rhythm Guide üìä

### Last Month's Weekly Patterns
```{r monthly_trading_patterns}
# Calculate monthly patterns (excluding weekends)
monthly_day_summary <- monthly_data %>%
  mutate(
    day_of_week = weekdays(date),
    is_up_day = returns > 0,
    avg_move = mean(returns, na.rm = TRUE)
  ) %>%
  filter(day_of_week %in% c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday")) %>%
  group_by(day_of_week) %>%
  summarize(
    success_rate = mean(is_up_day, na.rm = TRUE) * 100,
    average_move = mean(returns, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    success_rate_fmt = sprintf("%.1f", success_rate),
    average_move_fmt = sprintf("%.2f", average_move),
    day_rating = case_when(
      success_rate >= 70 ~ "üåü Exceptional Day",
      success_rate >= 60 ~ "‚≠ê Very Strong Day",
      success_rate >= 55 ~ "‚ú® Strong Day",
      success_rate >= 50 ~ "üí´ Positive Day",
      success_rate >= 45 ~ "üåô Neutral Day",
      success_rate >= 40 ~ "‚ö° Challenging Day",
      success_rate >= 35 ~ "üå©Ô∏è Difficult Day",
      TRUE ~ "‚õàÔ∏è Very Challenging Day"
    ),
    description = case_when(
      success_rate >= 70 ~ "Outstanding performance, highly reliable gains",
      success_rate >= 60 ~ "Very strong historical performance",
      success_rate >= 55 ~ "Consistently positive outcomes",
      success_rate >= 50 ~ "Generally favorable conditions",
      success_rate >= 45 ~ "Mixed performance, slight tendency down",
      success_rate >= 40 ~ "More challenging conditions prevail",
      success_rate >= 35 ~ "Historically difficult trading day",
      TRUE ~ "Significant historical headwinds"
    ),
    mood_color = case_when(
      success_rate >= 70 ~ "#006400",   # Dark green
      success_rate >= 60 ~ "#4CAF50",   # Medium green
      success_rate >= 55 ~ "#8BC34A",   # Light green
      success_rate >= 50 ~ "#CDDC39",   # Lime
      success_rate >= 45 ~ "#FFC107",   # Amber
      success_rate >= 40 ~ "#FF9800",   # Orange
      success_rate >= 35 ~ "#FF5722",   # Deep orange
      TRUE ~ "#B71C1C"                  # Dark red
    )
  ) %>%
  arrange(match(day_of_week, c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday")))

# Create monthly table
monthly_table <- monthly_day_summary %>%
  select(day_of_week, success_rate_fmt, average_move_fmt, day_rating, description) %>%
  rename(
    "Day of Week" = day_of_week,
    "Success Rate %" = success_rate_fmt,
    "Avg Return %" = average_move_fmt,
    "Market Mood" = day_rating,
    "Historical Pattern" = description
  )

# Apply row-specific styling
table_styled <- kable(monthly_table,
    format = "html",
    escape = FALSE,
    align = c('l', 'r', 'r', 'c', 'l'),
    caption = "Last Month's Weekly Rhythm"
  ) %>% 
  kable_styling() %>%
  row_spec(0, background = "#FFE5B4", color = "black")

# Apply individual row colors
for(i in 1:nrow(monthly_day_summary)) {
  table_styled <- table_styled %>%
    row_spec(i, background = monthly_day_summary$mood_color[i], color = "black")
}

table_styled
```

### This Year's Weekly Patterns
```{r yearly_trading_patterns}
# Calculate yearly patterns (excluding weekends)
yearly_day_summary <- yearly_data %>%
  mutate(
    day_of_week = weekdays(date),
    is_up_day = returns > 0
  ) %>%
  filter(day_of_week %in% c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday")) %>%
  group_by(day_of_week) %>%
  summarize(
    success_rate = mean(is_up_day, na.rm = TRUE) * 100,
    average_move = mean(returns, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    success_rate_fmt = sprintf("%.1f", success_rate),
    average_move_fmt = sprintf("%.2f", average_move),
    day_rating = case_when(
      success_rate >= 70 ~ "üåü Exceptional Day",
      success_rate >= 60 ~ "‚≠ê Very Strong Day",
      success_rate >= 55 ~ "‚ú® Strong Day",
      success_rate >= 50 ~ "üí´ Positive Day",
      success_rate >= 45 ~ "üåô Neutral Day",
      success_rate >= 40 ~ "‚ö° Challenging Day",
      success_rate >= 35 ~ "üå©Ô∏è Difficult Day",
      TRUE ~ "‚õàÔ∏è Very Challenging Day"
    ),
    description = case_when(
      success_rate >= 70 ~ "Historically exceptional performance",
      success_rate >= 60 ~ "Very strong year-long pattern",
      success_rate >= 55 ~ "Consistently positive yearly trend",
      success_rate >= 50 ~ "Generally favorable yearly pattern",
      success_rate >= 45 ~ "Mixed yearly performance",
      success_rate >= 40 ~ "Challenging yearly pattern",
      success_rate >= 35 ~ "Historically difficult day this year",
      TRUE ~ "Significant yearly challenges"
    ),
    mood_color = case_when(
      success_rate >= 70 ~ "#006400",   # Dark green
      success_rate >= 60 ~ "#4CAF50",   # Medium green
      success_rate >= 55 ~ "#8BC34A",   # Light green
      success_rate >= 50 ~ "#CDDC39",   # Lime
      success_rate >= 45 ~ "#FFC107",   # Amber
      success_rate >= 40 ~ "#FF9800",   # Orange
      success_rate >= 35 ~ "#FF5722",   # Deep orange
      TRUE ~ "#B71C1C"                  # Dark red
    )
  ) %>%
  arrange(match(day_of_week, c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday")))

# Create yearly table
yearly_table <- yearly_day_summary %>%
  select(day_of_week, success_rate_fmt, average_move_fmt, day_rating, description) %>%
  rename(
    "Day of Week" = day_of_week,
    "Success Rate %" = success_rate_fmt,
    "Avg Return %" = average_move_fmt,
    "Market Mood" = day_rating,
    "Historical Pattern" = description
  )

# Apply row-specific styling
table_styled <- kable(yearly_table,
    format = "html",
    escape = FALSE,
    align = c('l', 'r', 'r', 'c', 'l'),
    caption = "This Year's Weekly Rhythm"
  ) %>% 
  kable_styling() %>%
  row_spec(0, background = "#FFE5B4", color = "black")

# Apply individual row colors
for(i in 1:nrow(yearly_day_summary)) {
  table_styled <- table_styled %>%
    row_spec(i, background = yearly_day_summary$mood_color[i], color = "black")
}

table_styled
```

#### Understanding Your Weekly Rhythm Guide üìä

The Weekly Rhythm Guide analyzes how markets typically perform on each trading day. Here's what the indicators mean:

**Success Rate %**:
- 70%+ (üåü): Exceptionally strong historical performance
- 60-70% (‚≠ê): Very reliable positive performance
- 55-60% (‚ú®): Consistently good performance
- 50-55% (üí´): Slightly positive tendency
- 45-50% (üåô): Neutral performance
- 40-45% (‚ö°): Challenging conditions
- 35-40% (üå©Ô∏è): Historically difficult
- Below 35% (‚õàÔ∏è): Significant historical challenges

**Average Return %**: Shows typical magnitude of price movements for each day

**Market Mood**: Quick visual indicator of historical day performance

**Historical Pattern**: Detailed insight into typical market behavior for that day


## Summary Cards üìã

### Monthly Summary Card
```{r monthly_summary_card}
# Calculate monthly metrics with proper grouping
monthly_summary <- monthly_data %>%
  # First calculate individual market returns using normalized prices
  group_by(index_name) %>%
  summarize(
    monthly_return = ((last(norm_price) / first(norm_price)) - 1) * 100,  # using norm_price instead of price
    avg_daily_vol = sd(returns, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # Then calculate overall statistics
  summarize(
    total_markets = n(),
    growing_markets = sum(monthly_return > 0, na.rm = TRUE),
    strong_growth_markets = sum(monthly_return > 3, na.rm = TRUE),
    avg_return = mean(monthly_return, na.rm = TRUE),
    volatility = mean(avg_daily_vol, na.rm = TRUE)
  ) %>%
  mutate(
    market_mood = case_when(
      avg_return > 5 ~ "üìà Exceptional Growth",
      avg_return > 3 ~ "‚ÜóÔ∏è Strong Momentum",
      avg_return > 1 ~ "üìä Steady Progress",
      avg_return > 0 ~ "‚û°Ô∏è Modest Gains",
      avg_return > -1 ~ "‚ÜîÔ∏è Holding Pattern",
      avg_return > -3 ~ "‚ÜòÔ∏è Minor Weakness",
      avg_return > -5 ~ "üìâ Significant Pressure",
      TRUE ~ "‚ö†Ô∏è Major Challenges"
    ),
    stability = case_when(
      volatility < 0.5 ~ "üèÜ Exceptionally Calm",
      volatility < 1.0 ~ "üåü Very Stable",
      volatility < 1.5 ~ "‚≠ê Stable",
      volatility < 2.0 ~ "üí´ Moderate Movement",
      volatility < 2.5 ~ "‚ú® Active Markets",
      volatility < 3.0 ~ "üåä High Activity",
      TRUE ~ "üå™Ô∏è Turbulent Markets"
    ),
    mood_colors = case_when(
      avg_return > 5 ~ "#006400",   # Dark green
      avg_return > 3 ~ "#4CAF50",   # Medium green
      avg_return > 1 ~ "#8BC34A",   # Light green
      avg_return > 0 ~ "#CDDC39",   # Lime
      avg_return > -1 ~ "#FFC107",  # Amber
      avg_return > -3 ~ "#FF9800",  # Orange
      avg_return > -5 ~ "#FF5722",  # Deep orange
      TRUE ~ "#B71C1C"             # Dark red
    ),
    volatility_colors = case_when(
      volatility < 0.5 ~ "#006400",  # Dark green
      volatility < 1.0 ~ "#4CAF50",  # Medium green
      volatility < 1.5 ~ "#8BC34A",  # Light green
      volatility < 2.0 ~ "#CDDC39",  # Lime
      volatility < 2.5 ~ "#FFC107",  # Amber
      volatility < 3.0 ~ "#FF9800",  # Orange
      TRUE ~ "#F44336"               # Red
    )
  )

# Create monthly summary table with color coding
monthly_table <- data.frame(
  Metric = c(
    "Markets Tracked",
    "Growing Markets",
    "Strong Growth Markets (>3%)",
    "Average Monthly Return",
    "Market Mood",
    "Volatility Level",
    "Month's Story"
  ),
  Value = c(
    as.character(monthly_summary$total_markets),
    sprintf("%d (%.1f%%)", monthly_summary$growing_markets, 
            monthly_summary$growing_markets/monthly_summary$total_markets*100),
    sprintf("%d (%.1f%%)", monthly_summary$strong_growth_markets,
            monthly_summary$strong_growth_markets/monthly_summary$total_markets*100),
    sprintf("%.2f%%", monthly_summary$avg_return),
    monthly_summary$market_mood,
    monthly_summary$stability,
    paste0(ifelse(monthly_summary$avg_return > 0, "üéØ ", "üé≤ "),
           case_when(
             monthly_summary$avg_return > 5 ~ "Remarkable Monthly Surge",
             monthly_summary$avg_return > 3 ~ "Strong Monthly Advance",
             monthly_summary$avg_return > 1 ~ "Solid Monthly Progress",
             monthly_summary$avg_return > 0 ~ "Modest Monthly Gains",
             monthly_summary$avg_return > -1 ~ "Monthly Consolidation",
             monthly_summary$avg_return > -3 ~ "Monthly Adjustment",
             monthly_summary$avg_return > -5 ~ "Monthly Pressure",
             TRUE ~ "Monthly Recovery Mode"
           ))
  )
)

# Create the styled monthly table
table_styled <- kable(monthly_table,
    format = "html",
    escape = FALSE,
    align = c('l', 'l'),
    caption = "This Month at a Glance"
  ) %>% 
  kable_styling() %>%
  row_spec(0, background = "#FFE5B4", color = "black") %>%
  row_spec(1, background = "#F0F8FF") %>%
  row_spec(2:3, background = ifelse(monthly_summary$avg_return > 0, "#E8F8E8", "#FFF0F0")) %>%
  row_spec(4:5, background = monthly_summary$mood_colors) %>%
  row_spec(6, background = monthly_summary$volatility_colors) %>%
  row_spec(7, background = monthly_summary$mood_colors)

table_styled
```

### Yearly Summary Card
```{r yearly_summary_card}
# Calculate yearly metrics with proper grouping
yearly_summary <- yearly_data %>%
  # First calculate individual market returns using normalized prices
  group_by(index_name) %>%
  summarize(
    ytd_return = ((last(norm_price) / first(norm_price)) - 1) * 100,  # using norm_price instead of price
    avg_daily_vol = sd(returns, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # Then calculate overall statistics
  summarize(
    total_markets = n(),
    growing_markets = sum(ytd_return > 0, na.rm = TRUE),
    strong_growth_markets = sum(ytd_return > 10, na.rm = TRUE),
    avg_ytd_return = mean(ytd_return, na.rm = TRUE),
    yearly_volatility = mean(avg_daily_vol, na.rm = TRUE)
  ) %>%
  mutate(
    market_mood = case_when(
      avg_ytd_return > 20 ~ "üìà Bull Market Leader",
      avg_ytd_return > 15 ~ "‚ÜóÔ∏è Strong Bull Run",
      avg_ytd_return > 10 ~ "üìä Solid Uptrend",
      avg_ytd_return > 5 ~ "‚û°Ô∏è Positive Trend",
      avg_ytd_return > 0 ~ "‚ÜîÔ∏è Stable Markets",
      avg_ytd_return > -5 ~ "‚ÜòÔ∏è Minor Correction",
      avg_ytd_return > -10 ~ "üìâ Correction Phase",
      avg_ytd_return > -15 ~ "‚ö†Ô∏è Deep Correction",
      TRUE ~ "üîÑ Bear Market Territory"
    ),
    stability = case_when(
      yearly_volatility < 0.5 ~ "üèÜ Rock Solid Year",
      yearly_volatility < 1.0 ~ "üåü Very Stable Year",
      yearly_volatility < 1.5 ~ "‚≠ê Stable Year",
      yearly_volatility < 2.0 ~ "üí´ Moderate Year",
      yearly_volatility < 2.5 ~ "‚ú® Active Year",
      yearly_volatility < 3.0 ~ "üåä Volatile Year",
      TRUE ~ "üå™Ô∏è Highly Volatile Year"
    ),
    mood_colors = case_when(
      avg_ytd_return > 20 ~ "#006400",  # Dark green
      avg_ytd_return > 15 ~ "#4CAF50",  # Medium green
      avg_ytd_return > 10 ~ "#8BC34A",  # Light green
      avg_ytd_return > 5 ~ "#CDDC39",   # Lime
      avg_ytd_return > 0 ~ "#FFC107",   # Amber
      avg_ytd_return > -5 ~ "#FF9800",  # Orange
      avg_ytd_return > -10 ~ "#FF5722", # Deep orange
      avg_ytd_return > -15 ~ "#F44336", # Red
      TRUE ~ "#B71C1C"                  # Dark red
    ),
    volatility_colors = case_when(
      yearly_volatility < 0.5 ~ "#006400",  # Dark green
      yearly_volatility < 1.0 ~ "#4CAF50",  # Medium green
      yearly_volatility < 1.5 ~ "#8BC34A",  # Light green
      yearly_volatility < 2.0 ~ "#CDDC39",  # Lime
      yearly_volatility < 2.5 ~ "#FFC107",  # Amber
      yearly_volatility < 3.0 ~ "#FF9800",  # Orange
      TRUE ~ "#F44336"                      # Red
    )
  )

# Create yearly summary table
yearly_table <- data.frame(
  Metric = c(
    "Markets Tracked",
    "Growing Markets",
    "Strong Growth Markets (>10%)",
    "Average YTD Return",
    "Market Mood",
    "Volatility Level",
    "Year's Story"
  ),
  Value = c(
    as.character(yearly_summary$total_markets),
    sprintf("%d (%.1f%%)", yearly_summary$growing_markets, 
            yearly_summary$growing_markets/yearly_summary$total_markets*100),
    sprintf("%d (%.1f%%)", yearly_summary$strong_growth_markets,
            yearly_summary$strong_growth_markets/yearly_summary$total_markets*100),
    sprintf("%.2f%%", yearly_summary$avg_ytd_return),
    yearly_summary$market_mood,
    yearly_summary$stability,
    paste0(ifelse(yearly_summary$avg_ytd_return > 0, "üéØ ", "üé≤ "),
           case_when(
             yearly_summary$avg_ytd_return > 20 ~ "Exceptional Bull Market",
             yearly_summary$avg_ytd_return > 15 ~ "Strong Bull Run",
             yearly_summary$avg_ytd_return > 10 ~ "Solid Year of Gains",
             yearly_summary$avg_ytd_return > 5 ~ "Positive Year",
             yearly_summary$avg_ytd_return > 0 ~ "Stable Progress",
             yearly_summary$avg_ytd_return > -5 ~ "Minor Correction Year",
             yearly_summary$avg_ytd_return > -10 ~ "Correction Territory",
             yearly_summary$avg_ytd_return > -15 ~ "Significant Correction",
             TRUE ~ "Bear Market Navigation"
           ))
  )
)

# Create the styled yearly table
table_styled <- kable(yearly_table,
    format = "html",
    escape = FALSE,
    align = c('l', 'l'),
    caption = "This Year at a Glance"
  ) %>% 
  kable_styling() %>%
  row_spec(0, background = "#FFE5B4", color = "black") %>%
  row_spec(1, background = "#F0F8FF") %>%
  row_spec(2:3, background = ifelse(yearly_summary$avg_ytd_return > 0, "#E8F8E8", "#FFF0F0")) %>%
  row_spec(4:5, background = yearly_summary$mood_colors) %>%
  row_spec(6, background = yearly_summary$volatility_colors) %>%
  row_spec(7, background = yearly_summary$mood_colors)

table_styled
```

#### Understanding Your Summary Cards üìã

The Summary Cards provide a comprehensive view of market performance across different timeframes:

**Key Metrics**:
- Markets Tracked: Total markets in analysis
- Growing Markets: Number and percentage showing positive returns
- Strong Growth Markets: Exceptional performers (>3% monthly, >10% yearly)
- Average Return: Mean return across all markets

**Market Mood Scale**:
Monthly:
- üìà Exceptional Growth (>5%)
- ‚ÜóÔ∏è Strong Momentum (3-5%)
- üìä Steady Progress (1-3%)
- ‚û°Ô∏è Modest Gains (0-1%)
- ‚ÜîÔ∏è Holding Pattern (-1-0%)
- ‚ÜòÔ∏è Minor Weakness (-3 to -1%)
- üìâ Significant Pressure (-5 to -3%)
- ‚ö†Ô∏è Major Challenges (<-5%)

Yearly:
- üìà Bull Market Leader (>20%)
- ‚ÜóÔ∏è Strong Bull Run (15-20%)
- üìä Solid Uptrend (10-15%)
- ‚û°Ô∏è Positive Trend (5-10%)
- ‚ÜîÔ∏è Stable Markets (0-5%)
- ‚ÜòÔ∏è Minor Correction (-5-0%)
- üìâ Correction Phase (-10 to -5%)
- ‚ö†Ô∏è Deep Correction (-15 to -10%)
- üîÑ Bear Market (<-15%)

**Volatility Levels**:
- üèÜ Exceptionally Calm: Minimal fluctuations
- üåü Very Stable: Small, orderly movements
- ‚≠ê Stable: Normal market activity
- üí´ Moderate: Typical volatility
- ‚ú® Active: Increased movement
- üåä High: Notable volatility
- üå™Ô∏è Turbulent: Significant swings

## Report Information ‚ÑπÔ∏è
<div class="date-stamp">
- Report Generated: `r format(Sys.time(), "%B %d, %Y at %H:%M %Z")`
- Data Through: `r format(max(monthly_data$date), "%B %d, %Y")`
- Next Update: `r format(ceiling_date(Sys.Date(), "month"), "%B %d, %Y")`
</div>

<div class="helpful-note">
Remember: This report is like a weather forecast for markets - it helps you understand what's currently happening (last month and a Holt-Winters prediction of the coming two weeks), but doesn't predict exactly what will happen next which is from today and forward. Always consult with financial professionals for investment advice and please be aware of the current financial situation in your country. Remember that the only one responsible for your savings is you, do your best!
</div>

```{css, echo=FALSE}
/* Global text color settings */
body, p, h1, h2, h3, h4, h5, h6, th, td, li, .table, .tocify {
  color: black !important;
}

/* Enhanced TOC styling */
.tocify {
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
}

.tocify .tocify-item a {
  color: black !important;
  padding: 8px 15px;
}

.tocify .tocify-item.active > a {
  background-color: #e9ecef;
  border-left: 4px solid #4CAF50;
}

.tocify .tocify-subheader {
  text-indent: 15px;
}

.tocify .tocify-subheader .tocify-subheader {
  text-indent: 30px;
}

/* Dashboard styling */
.market-dashboard {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  line-height: 1.6;
  background: linear-gradient(to bottom, #ffffff, #f8f9fa);
  border-radius: 12px;
}

/* Plot styling - adjusted for consistent margins */
.plotly {
  margin: 30px 0 !important;  /* Changed to match other elements */
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
  background: white;
  padding: 15px;
  width: 100% !important;  /* Full width to match other elements */
  max-width: 100% !important;  /* Ensure it doesn't exceed container */
}

.plotly:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

/* Plot container alignment */
.plot-container.plotly {
  margin: 0 !important;  /* Remove automatic centering */
}

/* Table styling */
table {
  margin: 25px 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-radius: 12px;
  overflow: hidden;
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  background: white;
}

/* Header styling */
h2 {
  color: black !important;
  margin-top: 50px;
  padding-bottom: 12px;
  border-bottom: 3px solid #e1e8f0;
  font-weight: 600;
  letter-spacing: -0.5px;
  position: relative;
}

h2::after {
  content: '';
  position: absolute;
  bottom: -3px;
  left: 0;
  width: 60px;
  height: 3px;
  background: #4CAF50;
}

/* Note styling */
.helpful-note {
  background: linear-gradient(to right, #f8f9fa, white);
  border-left: 4px solid #4CAF50;
  padding: 20px;
  margin: 25px 0;
  border-radius: 0 12px 12px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Date stamp styling */
.date-stamp {
  text-align: center;
  color: black !important;
  font-size: 0.95em;
  margin: 25px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #eee;
}

/* Container width control */
div.main-container {  
  max-width: 95vw;
}

/* Ensure all content has consistent width */
.main-container {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
```
